<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>みんなの0円地図</title>
  <style>
    #map { width: 100%; height: 100vh; margin: 0; padding: 0; }
    body { margin: 0; }
    .legend {
      background: white;
      padding: 10px;
      margin: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      line-height: 1.6;
    }
    .legend img {
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    async function init() {
      try {
        const res = await fetch('map.csv');
        if (!res.ok) throw new Error('CSVを取得できませんでした');
        const csvText = await res.text();
        
        const rows = csvText.trim().split(/\r?\n/).map(line => {
          const m = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
          return m ? m.map(s => s.replace(/^"|"$/g, '')) : [];
        });
        
        const header = rows[0].map(h => h.toLowerCase());
        const titleIdx = header.indexOf('title');
        const urlIdx = header.indexOf('url');
        const statusIdx = header.indexOf('status');
        const lonIdx = header.indexOf('longitude');
        const latIdx = header.indexOf('latitude');
        const addrIdx = header.indexOf('address');
        
        const points = rows.slice(1).map(r => ({
          title: r[titleIdx],
          url: r[urlIdx],
          status: r[statusIdx],
          lng: parseFloat(r[lonIdx]),
          lat: parseFloat(r[latIdx]),
          address: r[addrIdx]
        })).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));
        
        const center = points.length
        ? { lat: points[0].lat, lng: points[0].lng }
        : { lat: 35.6812, lng: 139.7671 };
        
        const map = new google.maps.Map(document.getElementById('map'), {
          center,
          zoom: 12
        });
        
        const bounds = new google.maps.LatLngBounds();
        const info = new google.maps.InfoWindow();
        
        // ステータスごとの色マッピング
        const statusColors = {
          '募集中': 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
          '受付終了': 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
          '一時停止': 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
          '取引中止': 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        };
        
        points.forEach(p => {
          const iconUrl = statusColors[p.status] || 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png';
          
          const marker = new google.maps.Marker({
            position: { lat: p.lat, lng: p.lng },
            map,
            title: p.title,
            icon: { url: iconUrl }
          });
          
          marker.addListener('click', () => {
            const statusColors = {
              '募集中': '#4CAF50',   // 緑
              '受付終了': '#F44336', // 赤
              '一時停止': '#FFC107', // 黄
              '取引中止': '#2196F3'  // 青
            };
            const statusColor = statusColors[p.status] || '#9C27B0';
            
            const html = `
              <div style="font-family: sans-serif; max-width:300px;">
                <h3 style="margin:0 0 8px; font-size:16px; color:#333;">
                  ${escapeHtml(p.title)}
                </h3>
                <div style="margin-bottom:8px;">
                  <a href="${p.url}" target="_blank"
                    style="display:inline-block; padding:6px 12px; background:#1976D2; color:#fff; text-decoration:none; border-radius:4px; font-size:13px;">
                    詳細ページを見る
                  </a>
                </div>
                <div style="margin-bottom:6px;">
                  <span style="display:inline-block; padding:2px 6px; border-radius:3px; background:${statusColor}; color:#fff; font-size:12px;">
                    ${escapeHtml(p.status)}
                  </span>
                </div>
                <div style="font-size:13px; color:#555;">
                  ${p.address ? '住所: ' + escapeHtml(p.address) : ''}
                </div>
              </div>
            `;
            info.setContent(html);
            info.open(map, marker);
          });          
          bounds.extend(marker.getPosition());
        });
        
        if (points.length > 1) map.fitBounds(bounds);
        
        // 凡例を作成
        const legend = document.createElement('div');
        legend.className = 'legend';
        legend.innerHTML = '<strong>凡例</strong><br>';
        for (const [status, icon] of Object.entries(statusColors)) {
          legend.innerHTML += `<div><img src="${icon}"> ${status}</div>`;
        }
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
        
      } catch (err) {
        console.error(err);
      }
    }
    
    function escapeHtml(str) {
      return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
    }
    
    window.initMap = init;
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBs9U-Jl4u1xMntMKyaQq2bTKuuz5fZ4ho&callback=initMap" async defer></script>
</body>
</html>
